---
title: PFS: Multiplicaci칩n de Karatsuba
date: 2013-09-04T23:46:40+00:00
author: Kiko Correoso
slug: pfs-multiplicacion-de-karatsuba
tags: exponenciaci칩n binaria, optimizaci칩n, PFS, potencias, python, Python fuente de sabiduria

Vamos a seguir con nuestra serie sobre ['**p**ython, **f**uente de **s**abiduria'](http://pybonacci.org/tag/python-fuente-de-sabiduria/) hablando sobre la multiplicaci칩n.

쯊e has preguntado alguna vez c칩mo se multiplican dos n칰meros en un ordenador o calculadora? Normalmente, los <a href="http://en.wikipedia.org/wiki/Arithmetic_logic_unit" target="_blank">circuitos</a> de los procesadores incluyen operaciones b치sicas como la <a href="http://en.wikipedia.org/wiki/Multiplication_algorithm#Shift_and_add" target="_blank">multiplicaci칩n de enteros de tama침o peque침o</a>. Sobre estas operaciones b치sicas se construye todo lo dem치s.

El caso que nos ocupa hoy, multiplicar n칰meros enteros muy grandes, se consigue mediante el uso de algoritmos v칤a software. Una forma sencilla de calcular enteros es usando la misma metodolog칤a que us치bamos en la escuela, con la tabla de multiplicar del uno al diez y con sumas:

        23958233
            5830 칑
    ------------
        00000000 ( =      23,958,233 칑     0)
       71874699  ( =      23,958,233 칑    30)
     191665864   ( =      23,958,233 칑   800)
    119791165    ( =      23,958,233 칑 5,000)
    ------------
    139676498390 ( = 139,676,498,390        )
    

(ejemplo extra칤do de <a href="http://en.wikipedia.org/wiki/Multiplication_algorithm#Example" target="_blank">wikipedia</a>)

El algoritmo que hace uso de esa metodolog칤a se suele llamar `long`, `grade-school`, `na칦ve`,..., multiplication. En este caso vamos a hacer una implementaci칩n _sucia_ de este algoritmo descomponiendo el 'multiplicador' en d칤gitos que multiplicaremos al 'multiplicando':

<pre><code class="language-python">def naive(x, y):
    total = 0
    yy = [int(i) for i in str(y)]
    for i, yyy in enumerate(yy[::-1]):
        total += x * yyy * (10 ** i)
    return total</code></pre>

Para el ejemplo anterior (multiplicando = 23958233 y multiplicador = 5830) lo que estariamos haciendo ser칤a lo siguiente:

  * el multiplicador lo descomponemos en una lista de los d칤gitos que lo componen, [5, 8, 3, 0]
  * el 0 lo multiplicamos por el multiplicando
  * el 3 lo multiplicamos por 10 y por el multiplicando y lo sumamos al resultado del paso anterior
  * el 8 lo multiplicamos por 100 y por el multiplicando y lo sumamos al resultado del paso anterior
  * el 5 lo multiplicamos por 1000 y por el multiplicando y lo sumamos al resultado del paso anterior
  * devolvemos el resultado final

Esta es una forma de hacer multiplicaciones pero cuando los n칰meros involucrados en la multiplicaci칩n son muy grandes podemos encontrarnos con problemas de rendimiento y perder mucho tiempo haciendo un c치lculo.

Como en el desarrollo de Python hay gente muy inteligente, si buceas por el <a href="http://hg.python.org/cpython/file/tip/Objects/longobject.c" target="_blank">c칩digo fuente de Python</a> ver치s que para multiplicaci칩n de `long`'s se usa el algoritmo de la multiplicaci칩n r치pida de Karatsuba. 쯏 qui칠n demonios es este japon칠s? Pues este japon칠s <a href="http://en.wikipedia.org/wiki/Karatsuba_algorithm" target="_blank">es un ruso al que, con 23 a침itos (en 1960), se le ocurri칩 llevar la contraria al mism칤simo Kolmogorov</a>.

Lo mejor es que le ech칠is un ojo a la siguiente <a href="http://www.stoimen.com/blog/2012/05/15/computer-algorithms-karatsuba-fast-multiplication/" target="_blank">entrada</a> (o en la <a href="http://es.wikipedia.org/wiki/Algoritmo_de_Karatsuba" target="_blank">Wikipedia en espa침ol</a>) para entender m치s claramente el funcionamiento (<a href="http://en.wikipedia.org/wiki/Don%27t_repeat_yourself" target="_blank">DRY</a>). B치sicamente, de lo que se trata es de minimizar el n칰mero de multiplicaciones (aunque no siempre se consigue) usando una estrategia de 'divide y vencer치s'.

A continuaci칩n os dejo una implementaci칩n muy compacta que he encontrado en <a href="http://nayuki.eigenstate.org/page/karatsuba-multiplication" target="_blank">project nayuki</a> (si no entend칠is algo del c칩digo preguntad en los comentarios):

<pre><code class="language-python">## http://nayuki.eigenstate.org/res/karatsuba-multiplication/karatsuba.py
## http://nayuki.eigenstate.org/page/karatsuba-multiplication
_CUTOFF = 1024
def kara(x, y):
    if x.bit_length() &lt;= _CUTOFF or y.bit_length() &lt;= _CUTOFF:  # Base case
        #print('naive')
        return naive(x, y)
    else:
        #print('karatsuba')
        n = max(x.bit_length(), y.bit_length())
        half = (n + 32) // 64 * 32
        mask = (1 &lt;&lt; half) - 1
        xlow = x & mask
        ylow = y & mask
        xhigh = x &gt;&gt; half
        yhigh = y &gt;&gt; half
        a = kara(xhigh, yhigh)
        b = kara(xlow + xhigh, ylow + yhigh)
        c = kara(xlow, ylow)
        d = b - a - c
        return (((a &lt;&lt; half) + d) &lt;&lt; half) + c</code></pre>

Bien, pues vamos a ver si esto es capar de optimizar mi funci칩n `naive`. Para ello vamos a multiplicar el siguiente n칰mero (tened cuidado si vuestro ordenador no es muy potente ya que el c치lculo se puede llegar a alargar):

<pre><code class="language-python">num = 1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890*(10**14000)
print(num)</code></pre>

1234567890123456789012345678901234567890123456789012345678901234567890
  
1234567890123456789012345678900000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
0000000000000000000000000000000000000000000000000000000000000000000000
  
000000000000000000000000000000

( Qu칠 post m치s largo... 游뗵 )

Usando la funci칩n `naive`.

<pre><code class="language-python">a = naive(num, num)
%timeit naive(num, num)</code></pre>

`1 loops, best of 3: 1.31 s per loop`

Usando la funci칩n `kara`

<pre><code class="language-python">b = kara(num, num)
%timeit kara(num, num)</code></pre>

`10 loops, best of 3: 172 ms per loop`

<pre><code class="language-python">print(a == b)
print(1.31 / 0.173)</code></pre>

`True<br />
7.572254335260117`

Vemos que hemos conseguido una ganancia de 7.5x!!!

Aunque si comprobamos como lo hace Python vemos que no hemos hecho una gran optimizaci칩n (aunque no era lo importante de esta entrada):

<pre><code class="language-python">%timeit num * num</code></pre>

`1000 loops, best of 3: 455 췃s per loop`

Parece que solo es alrededor de 375 veces m치s r치pido 游땔

Este c칩digo lo he probado en Python 3.3, si veis alguna errata o alguna barbaridad que haya podido decir, por favor, av칤sadme.

Esta entrada la puedes descargar en formato notebook desde <a href="https://github.com/Pybonacci/notebooks" target="_blank">nuestro repositorio en github</a>.

P.D.: Pretend칤a que esta entrada fuera m치s rigurosa y completa pero mi tiempo se ha visto disminuido de forma dr치stica 칰ltimamente. La familia manda 游뗵